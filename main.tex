%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Template for USENIX papers.
%
% History:
%
% - TEMPLATE for Usenix papers, specifically to meet requirements of
%   USENIX '05. originally a template for producing IEEE-format
%   articles using LaTeX. written by Matthew Ward, CS Department,
%   Worcester Polytechnic Institute. adapted by David Beazley for his
%   excellent SWIG paper in Proceedings, Tcl 96. turned into a
%   smartass generic template by De Clarke, with thanks to both the
%   above pioneers. Use at your own risk. Complaints to /dev/null.
%   Make it two column with no page numbering, default is 10 point.
%
% - Munged by Fred Douglis <douglis@research.att.com> 10/97 to
%   separate the .sty file from the LaTeX source template, so that
%   people can more easily include the .sty file into an existing
%   document. Also changed to more closely follow the style guidelines
%   as represented by the Word sample file.
%
% - Note that since 2010, USENIX does not require endnotes. If you
%   want foot of page notes, don't include the endnotes package in the
%   usepackage command, below.
% - This version uses the latex2e styles, not the very ancient 2.09
%   stuff.
%
% - Updated July 2018: Text block size changed from 6.5" to 7"
%
% - Updated Dec 2018 for ATC'19:
%
%   * Revised text to pass HotCRP's auto-formatting check, with
%     hotcrp.settings.submission_form.body_font_size=10pt, and
%     hotcrp.settings.submission_form.line_height=12pt
%
%   * Switched from \endnote-s to \footnote-s to match Usenix's policy.
%
%   * \section* => \begin{abstract} ... \end{abstract}
%
%   * Make template self-contained in terms of bibtex entires, to allow
%     this file to be compiled. (And changing refs style to 'plain'.)
%
%   * Make template self-contained in terms of figures, to
%     allow this file to be compiled. 
%
%   * Added packages for hyperref, embedding fonts, and improving
%     appearance.
%   
%   * Removed outdated text.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[letterpaper,twocolumn,10pt]{article}
\usepackage{usenix2019_v3}
%\usepackage[sorting=none]{biblatex}

% to be able to draw some self-contained figs
\usepackage{tikz}
\usepackage{amsmath}
\usepackage{fancyvrb}
\usepackage{listings}
\usepackage{comment}

% inlined bib file
\usepackage{filecontents}
\providecommand{\shinfo}{\texttt{struct skb\_shared\_info }}
\providecommand{\page}{\texttt{struct page }}
\providecommand{\uarg}{\texttt{uarg }}
\providecommand{\kva}{kva }
\providecommand{\iova}{IOVA }
\providecommand{\mabaf}{malicious buffer }
\providecommand{\spb}{SPB\-2 }
%-------------------------------------------------------------------------------
\begin{document}
%-------------------------------------------------------------------------------

%don't want date printed
\date{}

% make title bold and 14 pt font (Latex default is non-bold, 16 pt)
\title{\Large \bf IOMMU and the Illusion of Safety}

% USENIX Security has double blind submissions
\begin{comment}
\author{
{\rm Markuze Alex}\\
Technion, VMware Research
\and
{\rm Gil Kupfer}\\
Technion
% copy the following lines to add more authors
\and
{\rm Nadav Amit}\\
VMware Research
\and{\rm Dan Tsafrir}\\
Technion, VMware Research
} % end author
\end{comment}

\maketitle

%-------------------------------------------------------------------------------
\begin{abstract}
%-------------------------------------------------------------------------------
\textcolor{magenta}{Your abstract text goes here. Just a few facts. Whet our appetites.
Not more than 200 words, if possible, and preferably closer to 150.\newline
We ignore the NDSS paper, the Linux attacks it mentions are at best half backed, which makes our contribution valid. We will still need to address it because the whole sub-page thing; but really its the Copy paper that introduced that notion and this is how we should frame it. The steps are \#1 Write paper as if NDSS doesn't exist. \#2 Add some defensive text when \#1 is complete}
\newline
\textcolor{blue}{Means, motive and opportunity; posioned KVA, DMA write access and vulberable cb pointer}
\end{abstract}


%-------------------------------------------------------------------------------
\section{Introduction}
Direct Memory Access (DMA) is a technology that allows input-output (I/O) devices to access the memory without CPU involvement. Before DMA, each I/O operation resulted in data being copied to and from the CPU, causing performance degradation. By letting devices access the memory directly, this copy overhead is avoided and the system is able to run faster. Yet, in its basic form, DMA makes the system vulnerable to DMA attacks, which are carried out by malicious devices that access memory regions not intended for their use. DMA attacks are well-known and have existed in the wild for over a decade \cite{Dor04,BDK10}. They range from stealing and manipulating sensitive data to taking over the victim machine. Popular attacks include: opening a locked computer \cite{MM, Fin14}; executing arbitrary code on the victim machine \cite{Fri16, Woj08, AD10}; stealing sensitive data items such as passwords \cite{SB12, LKV13, Cim16, BR12}; or extracting full memory dumps of victim machines for offline analysis \cite{MM, Vol, Fin14, GA10}. Modern systems protect themselves against DMA attacks using the input-output memory management unit (IOMMU). Inspired by the design of the ordinary MMU, the IOMMU adds a layer of virtual memory to devices. Instead of using physical addresses, the devices use I/O virtual addresses (IOVAs), which are translated into physical addresses by the IOMMU during each I/O transaction. Hence, devices are able to access only their mapped memory, leaving all other memory protected. Systems that use latest generation IOMMUs—and configure them correctly—are commonly believed to be fully protected from DMA attacks. In this work, by presenting several concrete attacks that remain valid even when an IOMMU is present in the system, we show that this perception is not true. Our attacks rely on the fact that operating systems (OSs) are usually long living, and are almost never designed from scratch. Even though it is possible to build a completely new operating system such that it will be fully protected, this task is very hard and not common. We claim that the way all state-of-the-art OSs treat I/O devices leads to wrong utilization of the IOMMU, and as a result makes them vulnerable. We start the work by exploring the disparity between IOMMU design and its actual utilization. In Chapter 3, we define and explain the sub-page granularity vulnerability and the deferred invalidation vulnerability, both caused by this gap. We also give a complete view of the attacks, including the attack boundaries and threat model. The sub-page granularity vulnerability comes from the fact that the IOMMU works in granularity of whole pages only. Using current technologies, it is impossible for an OS to define permissions for items smaller than a page. Yet, I/O buffers are typically smaller; in some cases, they are as small as a few bytes. Hence, I/O devices are able to access (potentially sensitive) data colocated with their buffers in the same page. Malicious devices might use this ability to manipulate or steal this data. Due the high cost of the translation process, the IOMMU caches the translations in the I/O translation look-aside buffer (IOTLB). The OS is responsible for removing stale entries from this buffer. Because of performance issues, OSs may defer the invalidation to a later time (Linux does it by default). This behavior exposes the system to the deferred invalidation vulnerability, which might be exploited by malicious devices that access the memory during the time the IOTLB is inconsistent with the IOMMU’s translation tables...
%-------------------------------------------------------------------------------
 
\input{background.tex}
\input{attack_mechanics.tex}
\input{os_defences.tex}
\input{attack_setup.tex}
\input{linux_net.tex}
\input{mitigations_future.tex}
\input{conclusion.tex}

%\input{appendix.tex}

\bibliographystyle{plain}
\bibliography{references}
\appendix

\input{appendixes/shellcode.tex}
\input{appendixes/dma_bidir.tex}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
