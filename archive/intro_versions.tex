\textcolor{blue}{

We focus on the most popular OS; coincidentally; w/o any known DMA attacks against it. We define, MMO in the context of DMA attacks; a schema to analyze DMA vulnerabilities. We demonstrate that DMA attacks go beyond trivial exploits in the presence of bad DMA hygiene. DMA vulnerabilities are a direct result of systematic disregard to DMA risks; resulting in APIs that make it a challenge to write a device driver that is not security liability. We focus on network devices, because these devices inherently, are easier to control remotely. But, the bad hygiene and the risks described are not limited to networking; as we show with the FireWire driver. DMA attacks are harder than it may seem; a malicious device with DMA access; can wreck havoc on existing systems. But, . In this work, we show that executing a DMA attack is not necessarily trivial, even when the attacker has unprivileged access. We show, that in order to execute a DMA and attacker must have all three out of \means,\motivation and \oportunity. On the one hand gaining all three is non trivial, which may cause a false sense of security; and on the other the pursuit, of all needed ingredients reveals a deep-seated disregard for DMA vulnerabilities. Previous works have resulted in local fixes, but not the adaptation of holistic solutions. We demonstrate how, even, when one layer of the network stack is trying to behave securely, it will often be subverted by a different layer of the same OS. We farther, show how a bad API inevitably leads to a compromised OS, and poor design choices. Ours is the first work to propose a schema for understanding DMA attacks, revealing the danger to be innate to DMA devices rather than just a set of anecdotal security flaws.}
\textcolor{green}{DMA attacks are actually harder than it may seem, and are important to explore in depth. We focus on Linux, because it is de-facto "the OS" of the Cloud; understanding its vulnerabilities is paramount. False assumptions, that DMA attacks are only as trivial as the NDSS paper lets us believe is actually a bane to security. Believing that DMA attacks exploit only anecdotal specific bugs leads to simple local patches. DMA security demands systematic rethinking of I/O security and the adoption of more holistic approaches...}
\textcolor{olive}{We aim to correct several misconceptions regarding DMA attacks; firstly there is more to DMA attacks than just unprivileged access... second: Its far from being the device drivers that are at fault; with the existing API its hard to write a good driver... While the drivers are the gateway to DMA attacks, it is often the Kernel itself that completes the needed trifecta for a DMA attack. Using MMO as our schema we have created a tool for static code analysis. Our tool flags dangerous mapping practices and sorts by severity, its important to note that our tool flags cases where \oportunity or \means are given; these by them selves do not show an attack but rather its ingredients. We believe that this should be enough to warrant a fix; as we show in \ref{sec:linux_net}; the danger is steal real. Even when some of the trifecta are seemingly missing; we show how a dedicated can gather the remainig members. Our tool is useful for both security researchers and driver developers; highlighting possible exposed structures that can leak a buffers address or expose a vulnerable callback functions.}
\begin{comment}
 
 %Our attacks rely on the fact that operating systems (OSs) are usually long living, and are almost never designed from scratch. Even though it is possible to build a completely new operating system such that it will be fully protected, this task is very hard and not common. 
 
%The reason for the numerous security vulnerabilities is the DMA API it self; writing a driver, that wont be a security burden is currently a challenge.
\newline 
We start the work by exploring the disparity between IOMMU design and its actual utilization. We define and explain the sub-page granularity vulnerability and the deferred invalidation vulnerability, both caused by this gap. We also give a complete view of the attacks, including the attack boundaries and threat model. 
 Due the high cost of the translation process, the IOMMU caches the translations in the I/O translation look-aside buffer (IOTLB). The OS is responsible for removing stale entries from this buffer. Because of performance issues, OSs may defer the invalidation to a later time (Linux does it by default). This behavior exposes the system to the deferred invalidation vulnerability, which might be exploited by malicious devices that access the memory during the time the IOTLB is inconsistent with the IOMMUâ€™s translation tables. With deferred protection mode, the device can access a memory region that the code will treat as immutable.
%black, blue, brown, cyan, darkgray, gray, green, lightgray, lime, magenta, olive, orange, pink, purple, red, teal, violet, white, yellow.
%\textcolor{orange}{V2:\newline 
A recent study\cite{thunder}, has exposed DMA vulnerabilities in multiple OSs. The project was able to "\emph{reveal endemic vulnerability in the presence of a more sophisticated attacker despite explicit use of the IOMMU to limit I/O attacks.}". The study has resulted in fixes applied to Windows,MacOS and FreeBSD. That study also theorised that the Linux kernel should also be vulnerable to DMA attacks; though no viable attacks were proposed. The current, common impression, is that the Linux kernel, with IOMMU enabled; is safe from DMA attacks. We demonstrate, that this common assumption is false; to the extent that producing non DMA-vulnerable device drivers is a non-trivial challenge. In this work we focus on privilege escalation attacks, where an attacker can run arbitrary code in kernel context. We also demonstrate, how under specific circumstances a device can get a full memory dump. Attacks, that cause memory corruption or can read random bits of memory, have already been demonstrated \cite{MMT16,thunder} and thus do not represent a novelty. We contend, that a malicious device, just like a human criminal; when perpetrating its attack has an MMO(Means, Motive and Opportunity). Farther more, without either of the three a privilege escalation attack is impossible. We show, that as long as the OS allows for sub-page vulnerabilities even a carefully authored device driver, can be subverted by performance optimizations in deeper OS layers.
%}
\end{comment}
\begin{comment}
\textcolor{teal}{V1:\newline
The thunderclap project \cite{thunder} has exposed weakness in multiple OSs. The project was able to "\emph{reveal endemic vulnerability in the presence of a more sophisticated attacker despite explicit use of the IOMMU to limit I/O attacks.}". Most of these vulnerabilities were due to clear disregard to good DMA hygiene; and resulted in fixes in these exposed OSs. In most cases all the ingredients for a DMA attack were immediately available, to the device. In this work, we present multiple concrete attacks, where the device has to work harder to lunch an attack. The sole bastion of security seemed to be the Linux Kernel. Thus, this work focuses on the Linux network stack that was declared to be mostly secure from DMA attacks, by the Thunderclap project. To date and to the best of our knowledge, no complete DMA attacks were demonstrated against IOMMU enabled Linux Kernel. It is important to disclose that the Thunderclap project, has claimed an attack on a Linux network devices, but the description was incomplete and the attack, as described, was infeasible. We actually use it as an example in section \ref{sec:mmo}, when talking about the necessary ingredients for a successful DMA attack. In this work, we attempt to show, that while each security hole can be plugged, when reported; DMA related risks are inevitable until sub-page vulnerability is systematically eliminated.}

In this paper we:
\begin{enumerate}
    \item Define a framework for a successful DMA attack \ref{sec:mmo}. 
    \item Demonstrate, how a buggy device driver (FireWire) can negate all OS counter measures \ref{sec:sbp2_attack}.
    \item Show, that even when a driver is carefully written, the OS can still betray it self to a malicious device; allowing the execution of arbitrary code and/or collecting a full memory dump \ref{sec:shinfo}.
    \item We provide a list of suggestion for a more secure OS.
\end{enumerate}
\end{comment}