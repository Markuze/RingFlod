\section{Introduction}

Direct Memory Access (DMA) is a technology that allows input-output (I/O) devices to access the memory without CPU involvement, improving system performance.
DMA capable devices include internal devices, such as GPUs, Network Interface Cards (NICs), storage devices (e.g., NVMe) and other peripheral devices, and external devices such as FireWire and Thunderbolt devices.\footnote{Currently, the Linux kernel (version 5.3) has as much as 700 such device drivers, where a third of those are network device drivers.} However, in its basic form, DMA makes the system vulnerable to DMA attacks, which are carried out by malicious DMA capable devices (e.g., from factory or by compromised firmware \cite{Gal14,Ben17a}) that access memory regions not intended for their use. 



DMA attacks are well-known and have existed in the wild for over a decade \cite{Dor04,BDK10,thunder}. These range from stealing and manipulating sensitive data to taking over the victim machine. Widespread attacks include: opening a locked computer \cite{MM, Fin14}; executing arbitrary code on the victim machine \cite{Fri16, Woj08, AD10,thunder}; stealing sensitive data items such as passwords \cite{SB12, LKV13, Cim16, BR12}; or extracting full memory dumps of victim machines for offline analysis \cite{MM, Vol, Fin14, GA10}. 

Modern systems protect themselves against such DMA attacks by using the I/O memory management unit (IOMMU). IOMMU, inspired by the design of the ordinary MMU, adds a layer of virtual memory to devices. That is, instead of using physical addresses, the devices use I/O virtual addresses (\iova). These \iova{} are created by the device driver via the DMA API (e.g., \texttt{dma\_map\_page} allocates a new \iova{} indicating a single physical page). \iova{} are translated into physical addresses by the IOMMU during each I/O transaction. Hence, by design, IOMMU provides address space isolation by allowing devices to access only their mapped pages, leaving all other memory pages inaccessible. 

However, unlike processes that operate in page granularity, I/O buffers can be significantly smaller and share pages with other kernel buffers. For this specific reason, known as the \subpage{} vulnerability \cite{MMT16,thunder}, IOMMU fails to protect the kernel from unprivileged access. That is, when I/O buffers are co-located with sensitive kernel buffers on the same page, devices can access potentially sensitive data. 

Malicious devices can exploit this vulnerability to construct their attacks. These range from simple random memory access exploits (e.g., memory corruption that can be used to crash the kernel) to the more dire privilege escalation attacks, where the attacker gains control over the victim machine.

Previously reported vulnerabilities have an ad-hoc nature \cite{thunder,MMT16,Ben17b} rather than a structured top-down approach. We argue that a structured approach is needed as it can lead to better threat detection and analysis, precipitating a more secure OS. Accordingly, in this work, we present a schema for identifying viable attack vectors by malicious DMA capable devices. Specifically, we introduce \means,~\motivation{} and \oportunity~(MMO) a trifecta of attributes, sufficient to lay out the space of DMA attacks (Section \ref{sec:mmo}):
\begin{enumerate}
    \item \motivation: A kernel buffer filled with malicious executable code; a \mabaf.
    \item \means: The kernel virtual address (\kva) of a \mabaf.
    \item \oportunity: Write access to a pointer; that can alter the CPU control flow.
\end{enumerate} 

The MMO schema is especially useful for vulnerability analysis. For example, we show that a privilege escalation attack requires the full trifecta to be realized. Other high impact attacks, such as full memory dump, may still be viable with only \oportunity{} given. 

We build a static code analysis tool inspired by MMO to flag high-risk device drivers. We use our tool on Linux Kernel 5.3 and identify numerous device drivers at risk for high impact DMA attacks such as privilege escalation by code injection and full memory dump. 

Often, the trifecta is present in a single buffer; this makes some DMA attacks straight forward (i.e., \simple{}). This apparent simplicity of known DMA attacks, where a single mistake in a data structure design compromises an entire system, is actually a bane to security. The anecdotal nature of these issues often leads to a patchwork of localized fixes rather than a comprehensive solution. 

We focus on more complex attacks; situations, where the MMO trifecta is incomplete. Analysis of such cases, as we find in this work, reveals a dangerous misconception. It is assumed, that buggy device drivers or poor but isolated design choices, are to blame for DMA vulnerabilities. We demonstrate that, in fact, it is often the Kernel itself, that supplements the missing pieces of the trifecta; showing that this is a deep-rooted issue rather than a collection of disjoint incidents.

To assess and validate our findings, we use a recent Linux kernel (version 5.3) that utilizes best practices for code injection mitigation, i.e., KASLR, NX-bit and has IOMMU enabled by default. Furthermore, Linux is the de facto OS of the cloud and runs on most of the world's servers. Linux also has no known DMA attacks against it, though some were theorized \cite{MMT16,thunder}. 

Nevertheless, in this work, we demonstrate how MMO can be used systematically to expose DMA vulnerabilities in the Linux kernel. For example, we demonstrate a \simple{} attack on the FireWire \spb{} driver (Section \ref{sec:sbp2_attack}) and show how this driver is marked by our static analysis tool. 
We then continue to tackle harder cases where the identified trifecta attributes are initially incomplete (i.e., \compound{} attacks), and human expertise is needed to exploit these vulnerabilities (Section \ref{sec:linux_net}). To summarize, our contributions in this paper are as follows:
\begin{itemize}
    \item We introduce the MMO Schema for evaluating kernel vulnerabilities to DMA attacks. 
    \item We develop an MMO inspired, static code analysis tool. We use it to evaluate the Linux kernel device drivers; and find numerous device drivers, at a high level of risk to DMA attack.
    \item We demonstrate, various MMO inspired DMA attacks on the Linux kernel, both \simple{} and \compound{}, i.e., such where initially the trifecta is seemingly incomplete. 
    \item We utilize our findings and provide a set of actionable advice for better DMA security, which is compatible with the performance needs of modern systems.
\end{itemize}