\section{Introduction}

Direct Memory Access (DMA) is a technology that allows input-output (I/O) devices to access memory without CPU involvement, improving system performance.
DMA capable devices include internal devices, such as GPUs, Network Interface Cards (NICs), storage devices (e.g., NVMe) and other peripheral devices, and external devices such as FireWire and Thunderbolt devices\footnote{Currently, the Linux kernel (version 5.0) has as much as 700 such device drivers, where a third of those are network device drivers.}. However, in its basic form, DMA makes the system vulnerable to DMA attacks. Namely, cases where malicious DMA-capable devices (e.g., compromised firmware \cite{Gal14,Ben17a}) access sensitive memory regions not intended for their use. 


Numerous DMA exploits are known \cite{Dor04,BDK10,thunder}, ranging from stealing and manipulating sensitive data to taking over the victim machine. Widespread attacks include: opening a locked computer \cite{MM, Fin14}; executing arbitrary code on the victim machine \cite{Fri16, Woj08, AD10,thunder}; stealing sensitive data items such as passwords \cite{SB12, LKV13, Cim16, BR12}; extracting a full memory dump of a victim machine \cite{MM, Vol, Fin14, GA10}. These threats are mitigated by the Inputâ€“Output Memory Management Unit (IOMMU). The IOMMU adds a layer of virtual memory to devices. The IOMMU brokers all I/O requests, translating their target I/O virtual addresses (IOVAs) to physical addresses. In the process, the IOMMU provides address space isolation, allowing devices access only to permitted pages
%\adam{DMA-mapped was not defined}
, rendering all other memory inaccessible.

However, unlike processes that operate in page granularity, I/O buffers can be significantly smaller than a page. I/O buffers and other kernel buffers can co-reside on the same physical pages, inadvertently exposing these Kernel buffers to the device. For this reason, known as the \subpage{} vulnerability \cite{MMT16,thunder}, IOMMU fails to protect the Kernel from unprivileged access. Consequently, sub-page vulnerability was used as a basis for several recent DMA exploits. 

However, previously reported vulnerabilities have an ad-hoc nature \cite{thunder,MMT16,Ben17b} rather than a structured top-down approach. We argue that a structured approach is needed as it can lead to better threat detection and analysis, precipitating a more secure OS.
\adam{I suggest removing the preceding sentences, and replace them with the
following message: there is no systematic study of how sub-page vulnerabilities can occur,
and how they can be exploited.  And this is what the paper does.}
Accordingly, in this work, we present a schema for identifying viable attack vectors by malicious DMA capable devices. Specifically, we introduce \means,~\motivation{} and \oportunity~(MMO) a trifecta of attributes, sufficient to layout the space of DMA attacks (Sec. \ref{sec:mmo}):
%\adam{the list below appears to target code execution exploits (e.g., if the attack is to steal secret data, there's no need for malicious code or write access). Perhaps say up front that these are the attacks under consideration.}
\begin{enumerate}
    \item \motivation: A kernel buffer filled with malicious executable code, a \mabaf.
    \item \means: The kernel virtual address (\kva) of a \mabaf.
    \item \oportunity: Write access to a pointer that can alter the CPU control flow.
\end{enumerate} 

The MMO schema is especially useful for vulnerability analysis. For example, we show that a privilege escalation attack requires the full trifecta to be realized. Other high impact attacks, such as a full memory dump, may still be viable with only \oportunity{} given. \adam{this paragraph can be dropped}

\adam{add a paragraph on the categorization of various ways sub-page vulns can occur (S3.2), and that they are sometimes caused by the OS design and not by a driver issue}

\adam{make the following relate to MMO.  IIUC, the tools are for identifying Opportunity, and then S7 discusses various ways of completing Motive and Means,}

We build a static code analysis tool inspired by MMO to flag high-risk device drivers. 
We use our tool on Linux Kernel 5.0 and find that as much as 62\% of device drivers are vulnerable to various DMA attacks (Sec.~\ref{sec:static-analysis}). 
These include high impact privilege escalation attacks by code injection in which the attacker gains full control of the victim machine.\adam{this paragraph needs to be more explicit: what does high-risk mean? Say exactly what the tool finds.}

%identify numerous device drivers at risk for high impact DMA attacks such as privilege escalation by code injection. 
%\adam{is it ``such as'' or only these attacks? (related to the above comment)}
%Specifically, using the tool, we find that as much as 62\% of device drivers are vulnerable to DMA attacks (Sec .\ref{sec:static-analysis}).
%\adam{the second part of the sentence isn't very clear: which types of DMA attacks are these? What OS design choices?}.

\adam{instead of this "Since...", make the focus on the scenario, i.e.: "Sub-vulnerabilities can also manifest dynamically at run-time, if a memory buffer is inadvertently ..."}
Since static analysis may not reveal opportunities for random access attacks, where a memory buffer is inadvertently exposed due to randomly sharing a page with an I/O buffer, we further develop a run-time analysis tool that reports such vulnerabilities and exemplify its use. The run-time analysis tool reports on all cases where a kernel-buffer is exposed. 

% \adam{what's a random access attack? The term hasn't been defined} we further develop a run-time analysis tool that reports dynamic DMA vulnerabilities. These include\adam{include random access, or only random access?} random access, where a memory buffer is inadvertently exposed due to randomly sharing a page with an I/O buffer\adam{aha, here's the definition... should come earlier, maybe even in the above paragraph, as I assume this is an instance (or ``the'' instance) of OS design choices leading to attacks}.


Straightforward DMA attacks (termed \simple attacks), where the MMO trifecta is present in a single page, often lead to localized fixes rather than a comprehensive solution \cite{thunder}.
%Often, the MMO trifecta is present in a single buffer, this makes some DMA attacks straightforward (i.e., \simple{}). 
%Cases where the MMO trifecta is present in a single page, make DMA attacks straightforward (i.e., \simple{}). 
%This apparent simplicity of known DMA attacks, where a single mistake compromises an entire system, 
%is a bane to security research. The anecdotal nature of these vulnerabilities 
%often leads to localized fixes rather than a comprehensive solution \cite{thunder}.
%Often, the MMO trifecta is present in a single buffer, this makes some DMA attacks straightforward (i.e., \simple{}). This apparent simplicity of known DMA attacks, where a single mistake compromises an entire system, is a bane to security research. The anecdotal nature of these vulnerabilities often leads to a patchwork of localized fixes rather than a comprehensive solution.
%\adam{the former two sentences a little hot air. I would simply say that such vulnerabilities are typically addressed with ``localized fixes'', explaining what such a fix looks like, and then move on to say that these types of fixes aren't enough because there are more sophisticated attacks}

We focus on more sophisticated attacks, i.e., situations where the MMO trifecta is initially incomplete (termed \compound attacks).
%\adam{how is ``trifecta is incomplete'' in contrast with the previous paragraph, which talked about MMO being present in a single buffer?}
Analysis of such cases, as we find in this work, reveals a dangerous misconception. It is assumed, that buggy device drivers or poor but isolated design choices, are to blame for DMA vulnerabilities. 
We demonstrate that, it is often the kernel itself, that supplements the missing pieces of the trifecta, showing that this is a deep-rooted issue rather than a collection of disjoint incidents.
\adam{is it "often"? I think everything described in S7 is kernel-related.  So maybe be more explicit and say that we identify design flaws in the Linux that enable NIC devices with Opportunity to gain Motive and Means}

%\adam{this text seems like it should come earlier, since earlier you talk about OS design choices}
%
To summarize, our contributions in this paper are:
\begin{itemize}
    \item We introduce the MMO Schema for characterizing and evaluating Kernel vulnerabilities to DMA attacks.
    \item We develop an MMO inspired, static code analysis tool. We use it to evaluate the Linux kernel device drivers and find numerous device drivers at a high level of risk to DMA attack.
    \item Since static analysis may not reveal opportunities for random access attacks, we develop a run-time tool to identify \subpage{} vulnerabilities, including random access.
    \item We demonstrate various MMO inspired DMA attacks on the Linux kernel. These include both \simple{} attacks and a new type of attacks we introduce, termed \compound{} attacks, in which initially the trifecta is incomplete. 
\end{itemize}


% To assess and validate our findings, we use a recent Linux Kernel (5.0) that utilizes state-of-the-art practices for code injection mitigation, i.e., KASLR, NX-bit and have IOMMU enabled by default. Furthermore, Linux is the de facto OS of the cloud and runs on most of the world's servers. Linux also has no known DMA attacks against it, though some were theorized \cite{MMT16,thunder}. 

% For example, \SV{add here an example for compaund...}\SV{remove until the end of the paragraph??}we demonstrate a \simple{} attack on the FireWire \spb{} driver (Sec. \ref{sec:sbp2_attack}) marked by our static analysis tool. 
% We then continue to tackle harder cases, i.e., \compound{} attacks. Cases where the identified trifecta attributes are initially incomplete, and human expertise is needed to exploit these vulnerabilities (Sec. \ref{sec:linux_net}). 


The rest of the paper is organized as follows:
in Sec. \ref{sec:background} we provide the necessary technical background. 
In Sec. \ref{sec:dma-risks} we introduce new theoretical basis to reason about DMA vulnerabilities.
Next, inspired by the new theoretical basis, in Sec. \ref{sec:static-analysis} and \ref{sec:dma-kasan} we describe and evaluate the tools we built to discover DMA vulnerabilities. 
In Sec. \ref{sec:attack_setup} we describe a \simple attack discovered by our \tool, and in Sec. \ref{sec:linux_net} we discuss novel \compound attacks where human expertise is needed to complete the necessary attack ingredients.


